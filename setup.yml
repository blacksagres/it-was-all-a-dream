- name: Dev Machine Setup ğŸ––
  hosts: localhost
  tasks:
    # --- Debian/Ubuntu ---

    - name: Install btop (Debian) âš™ï¸
      ansible.builtin.apt:
        name: btop
        state: present
      become: yes
      when: ansible_os_family == "Debian"

    - name: Install fastfetch (Debian) ğŸª„
      ansible.builtin.apt:
        name: fastfetch
        state: present
      become: yes
      when: ansible_os_family == "Debian"

    - name: Install fzf (Debian) ğŸ”
      ansible.builtin.apt:
        name: fzf
        state: present
      become: yes
      when: ansible_os_family == "Debian"

    - name: Install tmux (Debian) ğŸ’»
      ansible.builtin.apt:
        name: tmux
        state: present
      become: yes
      when: ansible_os_family == "Debian"

    # --- macOS ---

    - name: Install btop (macOS) âš™ï¸
      community.general.homebrew:
        name: btop
        state: present
      when: ansible_os_family == "Darwin"

    - name: Install fastfetch (macOS) ğŸª„
      community.general.homebrew:
        name: fastfetch
        state: present
      when: ansible_os_family == "Darwin"

    - name: Install fzf (macOS) ğŸ”
      community.general.homebrew:
        name: fzf
        state: present
      when: ansible_os_family == "Darwin"

    - name: Install tmux (macOS) ğŸ’»
      community.general.homebrew:
        name: tmux
        state: present
      when: ansible_os_family == "Darwin"

    # --- Cross-platform ---

    - name: Remove existing .tmux folder, if any ğŸ§¨
      ansible.builtin.file:
        path: ~/.tmux
        state: absent

    - name: Install TPM (Tmux Plugin Manager) ğŸ”Œ
      ansible.builtin.git:
        repo: https://github.com/tmux-plugins/tpm.git
        dest: ~/.tmux/plugins/tpm
        version: HEAD

    - name: Write .tmux.conf with gruvbox theme and mouse support ğŸ¨
      ansible.builtin.copy:
        dest: ~/.tmux.conf
        content: |
          set -g @plugin 'tmux-plugins/tpm'
          set -g @plugin 'tmux-plugins/tmux-sensible'
          set -g @plugin 'egel/tmux-gruvbox'
          set -g @tmux-gruvbox 'dark'
          set -g mouse on
          run '~/.tmux/plugins/tpm/tpm'

    - name: Install tmux-sensible plugin ğŸ”Œ
      ansible.builtin.git:
        repo: https://github.com/tmux-plugins/tmux-sensible.git
        dest: ~/.tmux/plugins/tmux-sensible
        version: HEAD

    - name: Install tmux-gruvbox plugin ğŸ¨
      ansible.builtin.git:
        repo: https://github.com/egel/tmux-gruvbox.git
        dest: ~/.tmux/plugins/tmux-gruvbox
        version: HEAD

    - name: Reload tmux configuration ğŸ¨
      ansible.builtin.shell: |
        tmux source-file ~/.tmux.conf
      ignore_errors: yes
      changed_when: false

    - name: Install nvm
      ansible.builtin.shell: |
        curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.5/install.sh | bash
      args:
        creates: "{{ lookup('ansible.builtin.env', 'HOME') }}/.nvm/nvm.sh"
      changed_when: false

    - name: Install npm using nvm
      ansible.builtin.shell: |
        export NVM_DIR="{{ lookup('ansible.builtin.env', 'HOME') }}/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
        nvm install --lts
      args:
        creates: "{{ lookup('ansible.builtin.env', 'HOME') }}/.nvm/versions/node"
      changed_when: false

    - name: Write git aliases file ğŸ”—
      ansible.builtin.copy:
        dest: "{{ lookup('ansible.builtin.env', 'HOME') }}/.gitconfig-aliases"
        content: |
          [alias]
                  st              = status
                  co              = checkout
                  cot             = checkout test
                  cob             = checkout -b
                  del             = branch -D
                  rename          = branch -m
                  rhead           = reset HEAD~
                  plog            = log --pretty=format:'%h%x09%an%x09%ad%x09%s'
                  pretty-logs     = log --color --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset' --abbrev-commit --branches
                  fco             = "!git branch | fzf | xargs git checkout"
                  stash-select    = !git stash list | fzf | awk -F: "{print \\$1}" | xargs git stash pop
                  my-prs          = !gh pr list -A $(git config user.name) | fzf | awk '{print $1}' | xargs gh pr view --web
                  clc             = "!git log -1 --format='%H' | tr -d '\\n' | { command -v pbcopy >/dev/null && pbcopy || command -v xclip >/dev/null && xclip -selection clipboard || xsel --clipboard --input; }"

    - name: Include git aliases in global gitconfig ğŸ”—
      ansible.builtin.shell: |
        git config --global --get-all include.path | grep -qF "$HOME/.gitconfig-aliases" || \
        git config --global --add include.path ~/.gitconfig-aliases
      changed_when: false
